# 开启一个Django项目

## 1. 创建k8s管理平台项目

```shell
django-admin startproject K8S-management-platform
```

## 2. 配置pycharm开发环境

* settings环境设置

```python
"""
Django settings for K8sManagementPlatform project.

Generated by 'django-admin startproject' using Django 3.0.5.

For more information on this file, see
https://docs.djangoproject.com/en/3.0/topics/settings/

For the full list of settings and their values, see
https://docs.djangoproject.com/en/3.0/ref/settings/
"""

import os

# Build paths inside the project like this: os.path.join(BASE_DIR, ...)
import sys

BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
root_dir = os.path.dirname(BASE_DIR)
sys.path.insert(0, os.path.join(root_dir, 'apps'))

print(sys.path)
# Quick-start development settings - unsuitable for production
# See https://docs.djangoproject.com/en/3.0/howto/deployment/checklist/

# SECURITY WARNING: keep the secret key used in production secret!
SECRET_KEY = 'hjw7c1j!#3*bacr%(k0mw$4c)bx_vdl8l)0zx&@-!o33ey#j+_'

# SECURITY WARNING: don't run with debug turned on in production!
DEBUG = True

ALLOWED_HOSTS = []


# Application definition

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'dashboard',
    'k8s',
    'workload',
    'loadbalancer',
    'storage'
]

MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]

ROOT_URLCONF = 'K8sManagementPlatform.urls'

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [os.path.join(root_dir, 'templates')],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.debug',
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]

WSGI_APPLICATION = 'K8sManagementPlatform.wsgi.application'


# Database
# https://docs.djangoproject.com/en/3.0/ref/settings/#databases

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.mysql',
        'NAME': 'devops1',
        'USER': 'root',
        'PASSWORD': '123456',
        'HOST': '192.168.0.203',
        'PORT': '3306'
    }
}

# Password validation
# https://docs.djangoproject.com/en/3.0/ref/settings/#auth-password-validators

AUTH_PASSWORD_VALIDATORS = [
    {
        'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator',
    },
]


# Internationalization
# https://docs.djangoproject.com/en/3.0/topics/i18n/

LANGUAGE_CODE = 'zh-hans'

TIME_ZONE = 'Asia/Shanghai'

USE_I18N = True

USE_L10N = True

USE_TZ = False


# Static files (CSS, JavaScript, Images)
# https://docs.djangoproject.com/en/3.0/howto/static-files/

#引用静态文件
STATICFILES_DIRS = (
    os.path.join(BASE_DIR, '../../static'),
)

STATIC_URL = '/static/'

LOGIN_URL = 'login'

```

## 3. 项目目录设计

![image-20240423102941069](C:\Users\Mark\AppData\Roaming\Typora\typora-user-images\image-20240423102941069.png)





# k8s管理平台开发

## 1. 登录模块

登录根据官方dashborad，设置kubeconf和token两种认证方式。

### 1.1 认证方式

* 证书认证

````
from kubernetes import client, config
import os
kubeconfig = os.path.join(os.getcwd(),"kubeconfig") # 获取当前目录并拼接文件
config.load_kube_config(kubeconfig)  # 指定kubeconfig配置文件（/root/.kube/config）
apps_api = client.AppsV1Api()  # 资源接口类实例化

for dp in apps_api.list_deployment_for_all_namespaces().items:
    print(dp)  # 打印Deployment对象详细信息
```
````



* token认证 

````
from kubernetes import client
import os
configuration = client.Configuration()
configuration.host = "https://192.168.31.61:6443"  # APISERVER地址
ca_file = os.path.join(os.getcwd(),"ca.crt") # K8s集群CA证书（/etc/kubernetes/pki/ca.crt）
configuration.ssl_ca_cert= ca_file
configuration.verify_ssl = True   # 启用证书验证
token = "eyJhbGciOiJSUzI1NiIsImtpZCI6ImdlQlFUM3..."  # 指定Token字符串，下面方式获取
configuration.api_key = {"authorization": "Bearer " + token}  
client.Configuration.set_default(configuration)
apps_api = client.AppsV1Api() 

for dp in apps_api.list_deployment_for_all_namespaces().items:
    print(dp)
```
````

### 1.2 登录代码

* login.html

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>登录</title>
    <script type="text/javascript" src="https://cdn.bootcdn.net/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <style>
        /* 整个内容区 */
        body {
            background-color: #edeff0;
        }
        .a {
            width: 900px;
            height: 400px;
            background-color: white;
            /* 定位到中间 */
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
            margin: auto;
            /* 添加阴影 */
            box-shadow: 0 2px 1px -1px rgba(0,0,0,.2), 0 1px 1px 0 rgba(0,0,0,.14), 0 1px 3px 0 rgba(0,0,0,.12);
        }
        /* 头部蓝色背景 */
        .c {
            height: 60px;
            width: 900px;
            background-color: #326de6;
            color: white;
            font-size: 20px;
        }
        /* 头部蓝色中文字向右移动并居中*/
        .c p {
            padding-left: 300px;
            padding-top: 12px;
            font-weight: bold;
            font-size: 26px;
            letter-spacing: 1px;
        }
        /* 所有文字右、下移 */
        .d,.e,.f,.g {
            padding-left: 300px;
        }

        /* 给选择按钮加超链接并加粗 */
        .d a, .e a {
            font-weight: bold;
            font-size: 18px;
            text-decoration: none;
        }
        /* 超链接显示处理 */
        a:active, a:link, a:visited, a:hover {color: black}
        /* 文字左、右向内靠拢 */
        .p {
            padding-left: 10px;
            padding-right: 10px;
        }
        /* 实心圆外面圆 */
        .s {
            display: block;
            width: 18px;
            height: 18px;
            border-radius: 20px;
            border: 2px solid gray;
            float: left;  /* 与Token水平 */
            margin-right: 10px;
        }
        /* 实心圆 */
        .ss {
            display: block;
            width: 10px;
            height: 10px;
            background-color: #326de6;
            border-radius: 20px;
            border: 2px solid white;
            /* 上、左移动，让实心圆居中 */
            position: relative;
            top: 13%;
            left: 10%;
        }
        .f, .g {
            display: none;  /* 默认两个input隐藏 */
        }
        .f input {
            width: 500px;
            height: 25px;
            border-style: none;
            border-bottom: 1px solid black;
            outline: none;  /* 点击输入框不显示外边框 */
            margin-top: 10px;
            margin-left: 10px;
        }
        .g input {
            margin-top: 10px;
            margin-left: 10px;
            color: gray;
            outline: none;
        }
        #btn {
            height: 50px;
            width: 150px;
            margin-left: 400px;
            margin-top: 40px;
            border-style: none;
            font-size: 22px;
            background-color: #326de6;
            color: white;
            padding: 8px 15px 8px 15px;
            outline: none;
            box-shadow: 0 2px 1px -1px rgba(0,0,0,.2), 0 1px 1px 0 rgba(0,0,0,.14), 0 1px 3px 0 rgba(0,0,0,.12);
        }
        #btn:hover {
            cursor: pointer;
        }

    </style>
</head>
<body>
{% csrf_token %}
<div class="a">
    <div class="b">
        <div class="c">
            <p>欢迎访问Kubernetes管理平台</p>
        </div>
        <div>
            <div class="d">
                <p><a href="#" id="tokenBtn"><span class="s" id="s1"><span id="ss1"></span></span>Token</a></p>
                <p class="p"></p>
            </div>
            <div class="e">
                <p><a href="#" id="kubeBtn"><span class="s" id="s2"><span id="ss2"></span></span>Kubeconfig</a></p>
                <p class="p"></p>
            </div>
            <div class="f" id="token">
                <input type="password" name="token" placeholder="输入token" >
            </div>
            <div class="g" id="kube">
                <input type="file" name="kubeconfig" id="kubeconfig">
            </div>
            <p><button type="button" id="btn">登录</button>&nbsp;&nbsp;&nbsp;<span id="notice"></span></p>
        </div>

    </div>
</div>
<script type="text/javascript">
    // 默认选中Toekn认证
    $("#token").css("display", "inline");  // 显示输入token
    $("#s1").css("border", "2px solid #326de6");  // 边框改为蓝色
    $("#ss1").addClass("ss");  // 添加蓝色实心圆

    $("#tokenBtn").click(function () {
        $("#token").css("display", "inline");  // 显示输入token
        $("#kube").css("display", "none");  // 另外一个隐藏

        $("#s1").css("border", "2px solid #326de6");  // 边框改为蓝色
        $("#s2").css("border", "2px solid gray");  // 另外一个，边框改为灰色

        $("#ss1").addClass("ss");  // 添加蓝色实心圆
        $("#ss2").removeClass("ss");  // 去掉蓝色实心圆
    });
    $("#kubeBtn").click(function () {
        $("#kube").css("display", "inline");   // 显示选择文件框
        $("#token").css("display", "none");  // 另外一个隐藏

        $("#s1").css("border", "2px solid gray");  // 另外一个，边框改为蓝灰色
        $("#s2").css("border", "2px solid #326de6");  // 边框改为蓝色

        $("#ss2").addClass("ss");  // 添加蓝色实心圆
        $("#ss1").removeClass("ss");  // 去掉蓝色实心圆
    });
    $("#btn").click(function () {
        var csrf_token = $('[name="csrfmiddlewaretoken"]').val();
        // 判断选择的认证方式，即有实心圆类
        if ($("#ss1").hasClass("ss")) {
            var token = $("input[name='token']").val();
            // 判断输入是否为空
            if (! token) {
                $("#notice").html("请输入Token！").css("color", "red");
                return
            }
            var data = {'token': token};
            $.ajax({
                type: "POST",
                url: "{% url 'login' %}",
                timeout: 5000,
                headers: {"X-CSRFToken": csrf_token,'Auth-Type': 'token'},
                dataType: "json",
                data: data,
                success: function(res) {
                    if (res.code == 0) {
                        location.href = "/"
                    } else if (res.code == 1){
                        $("#notice").html(res.msg).css("color", "red");
                    }
                },
                error: function (res) {
                    $("#notice").html("服务器接口异常！").css("color", "red");
                }
            })
        } else if ($("#ss2").hasClass("ss")) {
            var fd = new FormData();
            var file = $("#kubeconfig")[0].files[0];
            if (! file) {
                $("#notice").html("请选择kubeconfig文件！").css("color", "red");
                return
            }
            fd.append('file', file);
            $.ajax({
                type: "POST",
                url: "{% url 'login' %}",
                timeout: 5000,
                dataType: "json",
                headers: {"X-CSRFToken": csrf_token, 'Auth-Type': 'kubeconfig'},
                data: fd,
                processData: false,
                contentType: false,
                success: function(res) {
                    if (res.code == 0) {
                        location.href = "/"
                    } else if (res.code == 1){
                        $("#notice").html(res.msg).css("color", "red");
                    }
                },
                error: function () {
                    $("#notice").html("服务器接口异常！").css("color", "red");
                }
            })
        }
    })
</script>
</body>
</html>
```

* views

```python
from django.http import JsonResponse
from django.shortcuts import render, redirect
from scripts.auth import self_auth, self_login_auth
import os
import hashlib
import random


@self_login_auth
def index(request):
    return render(request, 'index.html')

#登录
def login(request):
    if request.method == 'GET':
        return render(request, 'login.html')
    elif request.method == 'POST':
        '''
        获取token
        验证有效性
        token入session
        返回状态码
        '''
        auth_type = request.headers.get('Auth-Type')
        if auth_type == 'token':
            token = request.POST.get('token', None)
            print(token)
            if self_auth(auth_type, token):
                request.session['is_login'] = True
                request.session['auth_type'] = 'token'
                request.session['token'] = token
                code = 0
                msg = '登录成功'
            else:
                code = 1
                msg = 'token无效！'

        elif auth_type == 'kubeconfig':
            file_obj = request.FILES.get('file')
            BASE_DIR = os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
            file_dir = os.path.join(BASE_DIR, 'upload')
            token_random = hashlib.md5(str(random.random()).encode()).hexdigest()
            file_path = os.path.join(file_dir, token_random)
            with open(file_path, 'w') as f:
                f.write(file_obj.read().decode('utf8'))

            if self_auth(auth_type, file_path):
                request.session['is_login'] = True
                request.session['auth_type'] = 'kubeconfig'
                request.session['token'] = token_random
                code = 0
                msg = '登录成功'
            else:
                code = 1
                msg = 'kubeconfig文件无效！'

            res = {'code': code, 'msg': msg}

        res = {'code': code, 'msg': msg}
        return JsonResponse(res)


#退出登录
def logout(request):
    request.session.flush()
    return  redirect('login')
```

* 登录验证函数及登录装饰器

```
from kubernetes import client, config
from django.shortcuts import  redirect
import os


#认证k8s集群来判断登录是否成功
def self_auth(auth_type, *args, **kwargs):
    if auth_type == 'token':
        configuration = client.Configuration()
        configuration.host = "https://192.168.0.110:8443"  # APISERVER地址
        ca_file = os.path.join(os.getcwd(), "ca.pem")  # K8s集群CA证书（/etc/kubernetes/pki/ca.crt）
        configuration.ssl_ca_cert = ca_file
        configuration.verify_ssl = False  # 启用证书验证
        token = args[0]  # 指定Token字符串，下面方式获取
        configuration.api_key = {"authorization": "Bearer " + token}
        client.Configuration.set_default(configuration)
        try:
            core_api = client.CoreApi()
            core_api.get_api_versions()  # 查看k8s版本，由此验证是否有效的
            return True
        except Exception as e:
            print(e)
            return False

    elif auth_type == 'kubeconfig':
        kubeconfig = args[0]  # 获取当前目录并拼接文件
        try:
            config.load_kube_config(kubeconfig)  # 指定kubeconfig配置文件（/root/.kube/config）
            core_api = client.CoreApi()
            core_api.get_api_versions()  # 查看k8s版本，由此验证是否有效的
            return True
        except Exception as e:
            print(e)
            return False

#对视图是否登录进行验证
def self_login_auth(func):
    def inner(request, *args, **kwargs):
        is_login = request.session.get('is_login', False)
        if is_login:
            return func(request, *args, **kwargs)
        else:
            return redirect("login")
    return inner
```





kubeconfig 入库没做 ok

namespace的浏览器存储没做

# session storage

一般为5M左右，只能存储字符串格式的数据，所以存储前需要转换成json串，需要时取出再转换。

标签页关闭就会清空

官方api有以下几种： 

getItem 获取 

setItem 设置 

removeItem  移除

 clear 清空 

sessionStorage.getItem('key') // 获取键名为key的值 localStorage.setItem('key','value') // 设置键名为key，并赋值，若存在就会 





作者：地霊殿__三無
链接：https://juejin.cn/post/7127561236165689380
来源：稀土掘金
著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。



























































































































































# Pipenv使用

Pipenv会自动帮你管理虚拟环境和依赖文件，并且提供了一系列命令和选项来帮助你实现各种依赖和环境管理相关的操作。

## 1. pipenv安装

```shell
pip install pipenv
```

## 2. 自动创建虚拟环境

```
pipenv install
```

## 3. 激活虚拟环境

```
 pipenv shell
```

## 4. 安装依赖到虚拟环境

```
pipenv install django
```

新项目会自动创建虚拟环境

## 5. 记录依赖

使用Pipenv时，什么都不必做，Pipenv会自动帮你管理依赖。Pipenv会在你创建虚拟环境时自动创建Pipfile和Pipfile.lock文件（如果不存在），并且会在你使用pipenv install和pipenv uninstall命令安装和卸载包时自动更新Pipfile和Pipfile.lock。

> 附注 Pipfile用来记录项目依赖包列表，而Pipfile.lock记录了固定版本的详细依赖包列表。

## 6. 区分开发依赖

使用Pipenv时，你只需要在安装pytest时添加一个--dev选项，它会自动被分类为开发依赖（写入Pipfile的dev-packages一节中）：

```
pipenv install pytest --dev
```











# 问题记录

## Broken pipe错误

表单里面的button默认type属性为submit，导致我每次点提交出发click触发事件后，立刻刷新页面，导致post请求未来得及响应连接就中断了，最终报错：Broken pipe